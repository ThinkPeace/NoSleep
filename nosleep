#!/usr/bin/env bash
set -euo pipefail

VERSION="dev"
REPO="ThinkPeace/NoSleep"

BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

strip_ansi() { sed -E 's/\x1B\[[0-9;]*[mK]//g'; }

show_help() {
  echo -e "${BOLD}â˜•ï¸  nosleep - macOS é˜²ä¼‘çœ å°å·¥å…·${NC}"
  echo "--------------------------------------------------------"
  echo -e "ç”¨æ³•: ${GREEN}nosleep${NC} [æ¨¡å¼] [æ—¶é—´/å‘½ä»¤]"
  echo ""
  echo -e "${BOLD}æ ¸å¿ƒåŠŸèƒ½:${NC}"
  echo "  é˜²æ­¢ macOS è¿›å…¥ç¡çœ æ¨¡å¼ã€‚æ”¯æŒå€’è®¡æ—¶ã€åå°æ¨¡å¼å’Œå‘½ä»¤è·Ÿéšã€‚"
  echo ""
  echo -e "${BOLD}å‚æ•°è¯´æ˜:${NC}"
  echo -e "  ${CYAN}(æ— å‚æ•°)${NC}      æ— é™æœŸä¿æŒå±å¹•å¸¸äº® (ç›´åˆ°æŒ‰ Ctrl+C åœæ­¢)"
  echo -e "  ${CYAN}<æ—¶é—´>${NC}        æŒ‡å®šä¿æŒå”¤é†’çš„æ—¶é•¿ (æ”¯æŒ s=ç§’, m=åˆ†, h=æ—¶, d=å¤©)"
  echo -e "  ${CYAN}bg${NC}            åå°æ¨¡å¼ (å…è®¸å±å¹•å…³é—­ï¼Œä½†ç³»ç»Ÿä¸ä¼‘çœ  - é€‚åˆä¸‹è½½/æŒ‚æœº)"
  echo -e "  ${CYAN}run${NC}           è¿è¡Œæ¨¡å¼ (åœ¨æŒ‡å®šå‘½ä»¤è¿è¡ŒæœŸé—´ä¿æŒå”¤é†’)"
  echo -e "  ${CYAN}update${NC}        å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬"
  echo -e "  ${CYAN}--version${NC}     æ˜¾ç¤ºç‰ˆæœ¬å·"
  echo -e "  ${CYAN}--help${NC}        æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
  echo ""
  echo -e "${BOLD}ä½¿ç”¨ç¤ºä¾‹:${NC}"
  echo -e "  1. ä¸´æ—¶ç¦»å¼€ï¼Œä¿æŒå±å¹•å¸¸äº®:"
  echo -e "     ${GREEN}nosleep${NC}"
  echo ""
  echo -e "  2. ä¿æŒå±å¹•äº® 1 å°æ—¶ 30 åˆ†é’Ÿ (ä»¥ä¸‹å†™æ³•å‡å¯):"
  echo -e "     ${GREEN}nosleep 90m${NC}"
  echo -e "     ${GREEN}nosleep 1.5h${NC}"
  echo ""
  echo -e "  3. æŒ‚æœºä¸‹è½½å¤§æ–‡ä»¶ 3 å°æ—¶ (å…è®¸é»‘å±çœç”µï¼Œä½†ä¸æ–­ç½‘):"
  echo -e "     ${GREEN}nosleep bg 3h${NC}"
  echo ""
  echo -e "  4. æ‰§è¡Œå¤‡ä»½è„šæœ¬ï¼Œå¤‡ä»½æœŸé—´ä¸è®¸ä¼‘çœ :"
  echo -e "     ${GREEN}nosleep run ./backup_script.sh${NC}"
  echo ""
}

show_version() {
  echo "nosleep version ${VERSION}"
}

require_macos() {
  if [[ "$(uname -s)" != "Darwin" ]]; then
    echo -e "${YELLOW}âŒ ä»…æ”¯æŒ macOS${NC}"
    exit 1
  fi
  if ! command -v caffeinate >/dev/null 2>&1; then
    echo -e "${YELLOW}âŒ æœªæ‰¾åˆ° caffeinateï¼Œè¯·ç¡®è®¤åœ¨ macOS ä¸Šè¿è¡Œ${NC}"
    exit 1
  fi
}

get_install_dir() {
  if [[ -d "/opt/homebrew/bin" ]]; then
    echo "/opt/homebrew/bin"
  else
    echo "/usr/local/bin"
  fi
}

need_sudo() {
  local target="$1"
  [[ ! -w "$(dirname "$target")" ]]
}

latest_release_json() {
  curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest"
}

extract_asset_url() {
  local json="$1"
  local name="$2"
  echo "$json" | grep -Eo 'https://[^\"]+' | grep "/${name}$" | head -n1
}

get_latest_version() {
  local json="$1"
  echo "$json" | grep -m1 '"tag_name"' | sed -E 's/.*"v?([^\"]+)".*/\1/'
}

sha256_file() {
  if command -v shasum >/dev/null 2>&1; then
    shasum -a 256 "$1" | awk '{print $1}'
  else
    sha256sum "$1" | awk '{print $1}'
  fi
}

update_self() {
  local json
  json="$(latest_release_json)"
  local version
  version="$(get_latest_version "$json")"
  if [[ -z "$version" ]]; then
    echo -e "${YELLOW}âŒ æ— æ³•è§£ææœ€æ–°ç‰ˆæœ¬${NC}"
    exit 2
  fi

  local asset_name="nosleep-${version}"
  local sha_name="nosleep-${version}.sha256"
  local asset_url
  local sha_url
  asset_url="$(extract_asset_url "$json" "$asset_name")"
  sha_url="$(extract_asset_url "$json" "$sha_name")"
  if [[ -z "$asset_url" || -z "$sha_url" ]]; then
    echo -e "${YELLOW}âŒ æœªæ‰¾åˆ°å‘å¸ƒèµ„äº§ï¼Œè¯·æ£€æŸ¥ Release${NC}"
    exit 2
  fi

  local tmpdir
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' EXIT

  curl -fsSL -o "$tmpdir/$asset_name" "$asset_url"
  curl -fsSL -o "$tmpdir/$sha_name" "$sha_url"

  local expected
  expected="$(awk '{print $1}' "$tmpdir/$sha_name")"
  local actual
  actual="$(sha256_file "$tmpdir/$asset_name")"
  if [[ "$expected" != "$actual" ]]; then
    echo -e "${YELLOW}âŒ æ ¡éªŒå¤±è´¥ï¼Œå·²ä¸­æ­¢å‡çº§${NC}"
    exit 3
  fi

  local target
  target="$(command -v nosleep || true)"
  if [[ -z "$target" ]]; then
    target="$(get_install_dir)/nosleep"
  fi

  if need_sudo "$target"; then
    sudo install -m 755 "$tmpdir/$asset_name" "$target"
  else
    install -m 755 "$tmpdir/$asset_name" "$target"
  fi

  echo -e "${GREEN}âœ… å·²å‡çº§åˆ°ç‰ˆæœ¬ ${version}${NC}"
}

# --- entry ---
require_macos

if [[ $# -eq 0 ]]; then
  echo -e "${GREEN}â˜•ï¸  Mac å°†æ— é™æœŸä¿æŒæ¸…é†’ (æŒ‰ Ctrl+C é€€å‡º)...${NC}"
  caffeinate -d -u -i
  exit 0
fi

case "$1" in
  --help|-h|help)
    show_help
    exit 0
    ;;
  --version|-v)
    show_version
    exit 0
    ;;
  update)
    update_self
    exit 0
    ;;
  run)
    shift
    if [[ $# -eq 0 ]]; then
      echo -e "${YELLOW}âŒ é”™è¯¯: è¯·æŒ‡å®šè¦è¿è¡Œçš„å‘½ä»¤${NC}"
      echo "ç¤ºä¾‹: nosleep run 'echo hello'"
      exit 1
    fi
    echo -e "${GREEN}â˜•ï¸  æ­£åœ¨è¿è¡Œå‘½ä»¤å¹¶ä¿æŒæ¸…é†’:${NC} $*"
    caffeinate -d -i "$@"
    exit $?
    ;;
  bg)
    MODE="system"
    shift
    ;;
  *)
    MODE="display"
    ;;
 esac

ARG="${1:-}"
if [[ -z "$ARG" ]]; then
  echo -e "${YELLOW}âŒ é”™è¯¯: ç¼ºå°‘æ—¶é—´å‚æ•°${NC}"
  echo "è¯·å°è¯•è¾“å…¥ 'nosleep --help' æŸ¥çœ‹ç”¨æ³•ã€‚"
  exit 1
fi

NUMBER=$(echo "$ARG" | sed 's/[^0-9.]//g')
UNIT=$(echo "$ARG" | sed 's/[0-9.]//g')
SECONDS=0

if [[ -z "$NUMBER" ]]; then
  echo -e "${YELLOW}âŒ é”™è¯¯: æ— æ³•è§£ææ—¶é—´æ ¼å¼ '$ARG'${NC}"
  exit 1
fi

if [[ -z "$UNIT" ]]; then UNIT="s"; fi

case "$UNIT" in
  s|sec)  SECONDS=$(echo "$NUMBER" | awk '{print int($1)}') ;;
  m|min)  SECONDS=$(echo "$NUMBER" | awk '{print int($1 * 60)}') ;;
  h|hour) SECONDS=$(echo "$NUMBER" | awk '{print int($1 * 3600)}') ;;
  d|day)  SECONDS=$(echo "$NUMBER" | awk '{print int($1 * 86400)}') ;;
  *)
    echo -e "${YELLOW}âŒ é”™è¯¯: æœªçŸ¥çš„æ—¶é—´å•ä½ '$UNIT'${NC}"
    exit 1
    ;;
 esac

if [[ "$SECONDS" -le 0 ]]; then
  echo -e "${YELLOW}âŒ é”™è¯¯: æ—¶é—´å¿…é¡»å¤§äº 0${NC}"
  exit 1
fi

READABLE=""
if [[ "$UNIT" == "h" || "$UNIT" == "hour" ]]; then READABLE="$NUMBER å°æ—¶"; \
elif [[ "$UNIT" == "m" || "$UNIT" == "min" ]]; then READABLE="$NUMBER åˆ†é’Ÿ"; \
elif [[ "$UNIT" == "d" || "$UNIT" == "day" ]]; then READABLE="$NUMBER å¤©"; \
else READABLE="$SECONDS ç§’"; fi

trap "echo -e '\\nğŸ›‘ å·²æ‰‹åŠ¨åœæ­¢ã€‚'; exit" SIGINT

if [[ "${MODE}" == "system" ]]; then
  echo -e "${GREEN}â˜•ï¸  ç³»ç»Ÿå°†åœ¨åå°è¿è¡Œ $READABLE${NC} (å…è®¸é»‘å±)"
  caffeinate -i -t "$SECONDS"
else
  echo -e "${GREEN}â˜•ï¸  å±å¹•å°†å¸¸äº® $READABLE${NC} (æŒ‰ Ctrl+C æå‰å–æ¶ˆ)"
  caffeinate -d -u -t "$SECONDS"
fi

if [[ $? -eq 0 ]]; then
  echo -e "${CYAN}ğŸ˜´ æ—¶é—´åˆ°ï¼Œæ¢å¤æ­£å¸¸ä¼‘çœ ç­–ç•¥ã€‚${NC}"
fi
